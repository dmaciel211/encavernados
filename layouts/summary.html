{{/* layouts/_default/summary.html */}}
<article class="post-summary" data-href="{{ .RelPermalink }}" role="link" tabindex="0" aria-label="{{ .Title }}">
  {{- $default := .Site.Params.defaultCover | default "/media/default-cover.webp" -}}
  {{- $coverTrim := .Params.cover | default "" | strings.TrimSpace -}}
  {{- $ytTrim := .Params.youtube | default "" | strings.TrimSpace -}}
  {{- $ytid := "" -}}
  {{- if $ytTrim -}}
    {{- if hasPrefix (lower $ytTrim) "http" -}}
      {{- $ytid = replaceRE `.*(?:v=|be/|embed/)([A-Za-z0-9_-]{11}).*` "$1" $ytTrim -}}
    {{- else -}}
      {{- $ytid = $ytTrim -}}
    {{- end -}}
    {{- if ne (len $ytid) 11 -}}
      {{- $ytid = "" -}}
    {{- end -}}
  {{- end -}}

  {{- $coverData := dict -}}
  {{- $coverKey := "summary-cover" -}}
  {{- $_ := .Scratch.Delete $coverKey -}}
  {{- if not $ytid -}}
    {{- partial "function/cover-image.html" (dict
        "Page" .
        "Cover" $coverTrim
        "Default" $default
        "Quality" 75
        "Sizes" "(min-width: 768px) 360px, 100vw"
        "Widths" (slice 320 480 640 750 960)
        "Scratch" .Scratch
        "Key" $coverKey
      ) -}}
    {{- $coverData = .Scratch.Get $coverKey | default dict -}}
  {{- end -}}

  {{- if $ytid }}
    <a href="{{ .RelPermalink }}">
      <img class="post-cover"
           src="{{ printf "https://img.youtube.com/vi/%s/hqdefault.jpg" $ytid | safeURL }}"
           alt="{{ .Title }}"
           loading="lazy">
    </a>
  {{- else if $coverData.src }}
    <a href="{{ .RelPermalink }}">
      {{- if $coverData.isResource -}}
        <picture>
          <source type="image/webp"
                  srcset="{{ $coverData.srcsetWebp }}"
                  sizes="{{ $coverData.sizes }}">
          <source srcset="{{ $coverData.srcset }}"
                  sizes="{{ $coverData.sizes }}">
          <img class="post-cover"
               src="{{ $coverData.src | safeURL }}"
               srcset="{{ $coverData.srcset }}"
               sizes="{{ $coverData.sizes }}"
               width="{{ $coverData.width }}"
               height="{{ $coverData.height }}"
               alt="{{ $coverData.alt }}"
               loading="lazy"
               decoding="async">
        </picture>
      {{- else -}}
        <img class="post-cover"
             src="{{ $coverData.src | safeURL }}"
             alt="{{ $coverData.alt }}"
             loading="lazy"
             onerror="this.onerror=null;this.src='{{ $default | safeURL }}'">
      {{- end -}}
    </a>
  {{- end }}

  <div class="post-text">
    <h2><a href="{{ .RelPermalink }}">{{ .Title }}</a></h2>

    <p class="post-summary__meta">
      <span class="post-summary__date">
        <time datetime="{{ .Date }}">{{ .Date.Format "02/01/2006" }}</time>
      </span>
      {{ with .Params.authors }}
        <span class="post-summary__meta-sep" aria-hidden="true">·</span>
        <span class="post-summary__authors">
          Por&nbsp;
          {{- $n := sub (len .) 1 -}}
          {{- range $i, $a := . -}}
            <a href="/authors/{{ $a | urlize }}">{{ $a }}</a>{{ if lt $i $n }}, {{ end }}
          {{- end -}}
        </span>
      {{ end }}
    </p>

    {{ with .Params.description }}
      <p class="post-description">{{ . | truncate 160 }}</p>
    {{ else }}
      <p class="post-description">{{ .Summary | truncate 160 }}</p>
    {{ end }}

    <a href="{{ .RelPermalink }}" class="read-more">Leer m&aacute;s &rarr;</a>
  </div>
</article>

{{- $scratch := .Page.Scratch -}}
{{- if and $scratch (not ($scratch.Get "card-click-handler")) -}}
  {{- $scratch.Set "card-click-handler" true -}}
  <script>
    (function () {
      var selectors = ['.post-card', '.post-summary'];

      function findCard(element) {
        for (var i = 0; i < selectors.length; i++) {
          var card = element.closest(selectors[i]);
          if (card) return card;
        }
        return null;
      }

      function navigate(card, event) {
        if (!card) return;
        var href = card.dataset ? card.dataset.href : card.getAttribute('data-href');
        if (!href) return;
        if (event && (event.metaKey || event.ctrlKey || event.shiftKey)) {
          window.open(href, '_blank');
        } else {
          window.location.href = href;
        }
      }

      document.addEventListener('click', function (event) {
        var card = findCard(event.target);
        if (!card) return;
        if (event.target.closest('.post-card__authors') || event.target.closest('.post-summary__authors')) return;
        if (event.target.closest('a')) return;
        event.preventDefault();
        navigate(card, event);
      });

      document.addEventListener('keydown', function (event) {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        var card = findCard(event.target);
        if (!card) return;
        if (event.target.closest('.post-card__authors') || event.target.closest('.post-summary__authors')) return;
        event.preventDefault();
        navigate(card, event);
      });
    })();
  </script>
{{- end -}}
