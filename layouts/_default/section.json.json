{{- $section := lower .Section -}}
{{- $categorySections := slice "articulos" "entrevistas" "reflexiones" -}}
{{- if in $categorySections $section -}}
  {{- $posts := slice -}}
  {{- range (where .Site.RegularPages "Section" "articulos").ByDate.Reverse -}}
    {{- $cats := .Params.categories -}}
    {{- $typ := printf "%T" $cats -}}
    {{- $match := false -}}
    {{- if eq $typ "string" -}}
      {{- $match = eq (lower (printf "%v" $cats)) $section -}}
    {{- else if or (eq $typ "[]string") (eq $typ "[]interface {}") -}}
      {{- range $c := $cats -}}
        {{- if eq (lower (printf "%v" $c)) $section -}}
          {{- $match = true -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if $match -}}
      {{- $posts = $posts | append . -}}
    {{- end -}}
  {{- end -}}
  [
  {{- $first := true -}}
  {{- range $p := $posts -}}
    {{- if not $first }},{{ end -}}
    {{- $first = false -}}
    {{- $raw := ($p.Params.cover | default "") | strings.TrimSpace -}}
    {{- $default := $p.Site.Params.defaultCover | default "/media/default-cover.webp" -}}
    {{- $yt := ($p.Params.youtube | default "") | strings.TrimSpace -}}
    {{- $key := (printf "cover-json-section-%s" $section) -}}
    {{- $_ := $p.Scratch.Delete $key -}}
    {{- partial "function/cover-image.html" (dict
        "Page" $p
        "Cover" $raw
        "Default" $default
        "Quality" 70
        "Sizes" "(min-width: 768px) 320px, 100vw"
        "Widths" (slice 320 480 640 800)
        "Scratch" $p.Scratch
        "Key" $key
      ) -}}
    {{- $coverData := $p.Scratch.Get $key | default dict -}}
    {{- $cover := "" -}}
    {{- if $yt -}}
      {{- $cover = $yt -}}
    {{- else if $coverData.src -}}
      {{- $cover = $coverData.src -}}
    {{- end -}}
    {
      "title": {{ $p.Title | jsonify }},
      "permalink": {{ $p.RelPermalink | jsonify }},
      "date": {{ $p.Date.Format "2006-01-02" | jsonify }},
      {{- $authorsRaw := $p.Params.authors -}}
      {{- $authorsList := slice -}}
      {{- if $authorsRaw -}}
        {{- $typ := printf "%T" $authorsRaw -}}
        {{- if or (eq $typ "[]string") (eq $typ "[]interface {}") -}}
          {{- range $authorsRaw -}}
            {{- $name := strings.TrimSpace (printf "%v" .) -}}
            {{- if ne $name "" -}}
              {{- $authorsList = $authorsList | append $name -}}
            {{- end -}}
          {{- end -}}
        {{- else -}}
          {{- $name := strings.TrimSpace (printf "%v" $authorsRaw) -}}
          {{- if ne $name "" -}}
            {{- $authorsList = $authorsList | append $name -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
      "author": {{ (delimit $authorsList ", ") | jsonify }},
      "authors": [
        {{- $firstAuthor := true -}}
        {{- range $authorsList -}}
          {{- $name := . -}}
          {{- $slug := urlize $name -}}
          {{- $permalink := "" -}}
          {{- if ne $slug "" -}}
            {{- with site.GetPage (printf "/authors/%s" $slug) -}}
              {{- $permalink = .RelPermalink -}}
            {{- end -}}
            {{- if eq $permalink "" -}}
              {{- $permalink = printf "/authors/%s/" $slug -}}
            {{- end -}}
          {{- end -}}
          {{- if $firstAuthor -}}{{- $firstAuthor = false -}}{{- else -}},{{- end -}}
          {
            "name": {{ $name | jsonify }},
            "permalink": {{ if $permalink }}{{ $permalink | jsonify }}{{ else }}null{{ end }}
          }
        {{- end -}}
      ],
      "categories": {{ if $p.Params.categories }}{{ $p.Params.categories | jsonify }}{{ else }}[]{{ end }},
      "tags": {{ if $p.Params.tags }}{{ $p.Params.tags | jsonify }}{{ else }}[]{{ end }},
      "cover": {{ if $cover }}{{ $cover | jsonify }}{{ else }}null{{ end }},
      "youtube": {{ ($p.Params.youtube | default "") | jsonify }},
      "summary": {{ with $p.Params.description }}{{ . | plainify | truncate 160 | jsonify }}{{ else }}{{ $p.Summary | plainify | truncate 160 | jsonify }}{{ end }}
    }
  {{- end -}}
  ]
{{- else -}}
  {{- $items := .Pages.ByDate.Reverse -}}
  [
  {{- $first := true -}}
  {{- range $p := $items -}}
    {{- if not $first }},{{ end -}}
    {{- $first = false -}}
    {
      "title": {{ $p.Title | jsonify }},
      "permalink": {{ $p.RelPermalink | jsonify }},
      "date": {{ $p.Date.Format "2006-01-02" | jsonify }}
    }
  {{- end -}}
  ]
{{- end -}}
