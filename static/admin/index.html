<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Encavernados — Admin</title>

    <!-- Importante: cargamos el widget de Identity solo para que Decap pueda leer el token si ya existe.
         NO abrimos ningún modal ni tocamos invites. -->
    <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- Decap CMS (ex Netlify CMS) -->
    <script defer src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </head>
  <body>
    <div id="nc-root"></div>

    <script>
      // Función: ¿hay sesión activa? (token de Netlify Identity guardado)
      function isLoggedIn() {
        try {
          const raw = localStorage.getItem('gotrue.user'); // así lo guarda Identity
          if (!raw) return false;
          const data = JSON.parse(raw);
          if (!data || !data.token || !data.expires_at) return false;
          // chequeo de expiración básico
          return new Date(data.expires_at).getTime() > Date.now() + 5000;
        } catch (e) {
          return false;
        }
      }

      // Sin tocar invites ni modales: si no hay sesión, mandamos a la UI nativa de Netlify
      document.addEventListener('DOMContentLoaded', function () {
        if (!isLoggedIn()) {
          // redirige al login/recupero nativo de Netlify en la MISMA pestaña
          location.replace('/.netlify/identity');
          return;
        }
        // Si hay sesión, dejamos que Decap CMS monte su panel en #nc-root
        // (no hacemos init manual; el script de Decap ya auto-inicializa).
      });
    </script>
  </body>
</html>